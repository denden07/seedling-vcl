---
metadata:
  partial_name: 2FA | 2FA setup
---
   {% assign hashed = 16 | random_string | compute_hmac: "nonce", "MD4" %}
    {%- content_for 'page_nonce' -%}{{ context.instance.uuid | base64_encode |  append: hashed }}{%- endcontent_for -%}
    {%- capture page_nonce -%}{%- yield 'page_nonce' -%}{%- endcapture -%}
    {% include "modules/insites_core/sessions/delete_session_variables" %}
    
    <form action="/account/2fa" method="post" html-enctype="multipart/form-data" accept-charset="utf-8" >
        {% render 'modules/insites_core/authenticity_token', context: context %}
        <div class="setup-2fa-container">
            <div class="grid-x">
                <div class="large-12 cell text-center {%-  if context.params.slug == 'profile' -%}text-left{%- endif -%}">
                    {% if context.params.slug == 'profile' %}
                        <h4>Your account is not protected with two-factor authentication</h4>
                    {% else %}
                        <h1 class="title-4">
                            Enable Two-Factor Authentication
                        </h1>
                    {% endif %}
                  
                    <div class="spacer small"></div>
                    <p class="paragraph-medium">
                        Use the Google or Microsoft Authenticator App to scan this QR code to set up your verification device.
                    </p>
                    <div class="spacer"></div>
                </div>
                <div class="large-12 cell text-center">
                    {% assign issuer = 'Insites Instance ' |  append: context.instance.name %}
                    {% graphql generate_secret_key = 'modules/insites_core/two_factor_auth/generate_secret_key', email: context.current_user.email, issuer: issuer %}
                    {% assign otp = generate_secret_key.items.results.first | fetch: "otp" %}
                    
                    <div class="qr-code-details-wrapper">
                        <div class="qr-code {%  if context.params.slug == 'profile' %} qr-code-left {%- endif -%}">
                            {{ otp.secret_as_svg_qr_code }}
                        </div>
                        <div class="form-label">
                            <div class="spacer small"></div>
                            <p class="{%-  if context.params.slug == 'profile' -%}text-left{%- endif -%}">Or enter the code manually</p>
                                <div class="spacer x-small"></div>
                        </div>
                        <div class="manual-code-wrap">
                            <div class="manual-code-content wrap-content {%  if context.params.slug == 'profile' %} manual-code-content-left{%- endif -%}">
                                <pre id="setup_code">{{ otp.secret }}</pre>
                                <div class="copy-btn">
                                    <span class="icon-content_copy"></span>
                                </div>
                            </div>
                        </div>
                        <div class="spacer x-large"></div>
                        
                        <h5 class="title-5 {%  if context.params.slug == 'profile' %}text-left{%- endif -%}">
                            Verification Code
                        </h5>
                    {%  if context.params.slug == 'profile' %} 
                        <p  class="paragraph-small text-left">Enter the verification code generated by your authentication app to enable two-factor authentication.</p>
                    {% else %}
                        <p class="paragraph-small">
                            Enter Verification Code generated by your authentication app.
                        </p>
                    {%- endif -%}
                        
                        <div class="spacer"></div>
    
                        <div class="otp-input-wrapper {%  if context.params.slug == 'profile' %} manual-code-content-left{%- endif -%}">
                            <input name="2fa[otp_code]" type="hidden">
                            <input name="from_page" type="hidden" value="{{ context.params.slug }}">
    
                            <div class="otp_input_fields">
                                {% for i in (0..5) %}
                                    <input inputmode="numeric" pattern="[0-9]*" type="text" maxlength="1" class="otp_input" autocomplete="off" required disabled/>
                                {% endfor %}
                            </div>
                        </div>
                        {% if context.params.status %}
                            <div class="spacer x-small"></div>
                            <p class="paragraph-small is-invalid-label {%  if context.params.slug == 'profile' %}text-left{%- endif -%}">
                                Invalid code please try again.
                            </p>
                        {% endif %}
                        <ins-button type="submit" class="hide fa-btn {%  if context.params.slug == 'profile' %} qr-code-left {%- endif -%}" label="{%  if context.params.slug == 'profile' %} Turn on Two-Factor Authentication {% else %} Submit {%- endif -%}" id="submit_button" solid color="blue" size="large"></ins-button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    {%- if context.environment == "staging" -%}
        <script nonce="{{ page_nonce }}" src="{{ 'modules/dashboard/scripts/2fa/otp.js' | asset_url }}"></script>
    {% else %}
        <script nonce="{{ page_nonce }}" src="{{ 'modules/dashboard/scripts/2fa/otp.min.js' | asset_url }}"></script>
    {%- endif -%}